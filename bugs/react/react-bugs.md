# React Bug è®°å½•ï¼ˆé”™é¢˜æœ¬ï¼‰

è®°å½•åœ¨ä½¿ç”¨ React è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚

---

## ğŸ é—®é¢˜ 1ï¼šuseEffect æ— é™å¾ªç¯

### ğŸ’¬ å‘ç°åœºæ™¯
åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ `useEffect` è·å–æ•°æ®æ—¶ï¼Œå‘ç°é¡µé¢ä¸€ç›´åœ¨é‡æ–°æ¸²æŸ“ï¼Œæ§åˆ¶å°ç–¯ç‹‚æ‰“å°æ—¥å¿—ã€‚

### âŒ é”™è¯¯ç¤ºä¾‹
```jsx
function UserProfile({ userId }) {
  const [user, setUser] = useState(null);

  // ğŸš¨ é”™è¯¯ï¼šä¾èµ–æ•°ç»„ä¸­ä¼ å…¥äº†å¯¹è±¡
  useEffect(() => {
    fetchUser(userId).then(data => setUser(data));
  }, [user]); // æ¯æ¬¡ user æ›´æ–°éƒ½ä¼šè§¦å‘ï¼Œé€ æˆæ— é™å¾ªç¯ï¼

  return <div>{user?.name}</div>;
}
```

### âœ… æ­£ç¡®å†™æ³•
```jsx
function UserProfile({ userId }) {
  const [user, setUser] = useState(null);

  // âœ… æ­£ç¡®ï¼šåªä¾èµ– userId
  useEffect(() => {
    fetchUser(userId).then(data => setUser(data));
  }, [userId]); // åªæœ‰ userId å˜åŒ–æ—¶æ‰é‡æ–°è·å–

  return <div>{user?.name}</div>;
}
```

### ğŸ” åŸå› åˆ†æ
1. React çš„ä¾èµ–æ•°ç»„ä¼šè¿›è¡Œ**æµ…æ¯”è¾ƒ**ï¼ˆshallow comparisonï¼‰
2. å¯¹è±¡å’Œæ•°ç»„æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°çš„å¼•ç”¨ï¼Œå³ä½¿å†…å®¹ç›¸åŒ
3. å¦‚æœæŠŠ `user` æ”¾åœ¨ä¾èµ–æ•°ç»„ä¸­ï¼š
   - useEffect æ‰§è¡Œ â†’ æ›´æ–° user
   - user å˜åŒ– â†’ è§¦å‘ useEffect
   - å½¢æˆæ— é™å¾ªç¯

### ğŸ’¡ æ€»ç»“ä¸å»¶ä¼¸
- ä¾èµ–æ•°ç»„åªæ”¾**åŸå§‹ç±»å‹**æˆ–**ç¨³å®šçš„å¼•ç”¨**
- å¯¹äºå¯¹è±¡/æ•°ç»„ä¾èµ–ï¼Œåªä¾èµ–å…·ä½“çš„å±æ€§å€¼ï¼ˆå¦‚ `user.id`ï¼‰
- ä½¿ç”¨ ESLint æ’ä»¶ï¼š`eslint-plugin-react-hooks` ä¼šæç¤ºä¾èµ–é—®é¢˜
- å¦‚æœç¡®å®éœ€è¦ä¾èµ–å¯¹è±¡ï¼Œè€ƒè™‘ä½¿ç”¨ `useMemo` æˆ– `useCallback`

### ğŸ”– æ ‡ç­¾
`#react` `#useEffect` `#bugfix` `#infinite-loop`

---

## ğŸ é—®é¢˜ 2ï¼šç»„ä»¶çŠ¶æ€æ›´æ–°ä¸åŠæ—¶

### ğŸ’¬ å‘ç°åœºæ™¯
ç‚¹å‡»æŒ‰é’®åç«‹å³ä½¿ç”¨ state çš„å€¼ï¼Œå‘ç°æ‹¿åˆ°çš„è¿˜æ˜¯æ—§å€¼ã€‚

### âŒ é”™è¯¯ç¤ºä¾‹
```jsx
function Counter() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    setCount(count + 1);
    console.log(count); // ğŸš¨ è¾“å‡ºçš„æ˜¯æ—§å€¼ï¼
    // å‡è®¾ count åŸæ¥æ˜¯ 0ï¼Œè¿™é‡Œä¼šæ‰“å° 0 è€Œä¸æ˜¯ 1
  };

  return <button onClick={handleClick}>ç‚¹å‡»ï¼š{count}</button>;
}
```

### âœ… æ­£ç¡®å†™æ³•

**æ–¹æ³• 1ï¼šä½¿ç”¨å‡½æ•°å¼æ›´æ–°**
```jsx
function Counter() {
  const [count, setCount] = useState(0);

  const handleClick = () => {
    setCount(prevCount => {
      const newCount = prevCount + 1;
      console.log('æ–°å€¼:', newCount); // âœ… è¿™é‡Œèƒ½æ‹¿åˆ°æ–°å€¼
      return newCount;
    });
  };

  return <button onClick={handleClick}>ç‚¹å‡»ï¼š{count}</button>;
}
```

**æ–¹æ³• 2ï¼šä½¿ç”¨ useEffect ç›‘å¬å˜åŒ–**
```jsx
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log('count æ›´æ–°äº†:', count); // âœ… åœ¨è¿™é‡Œèƒ½æ‹¿åˆ°æœ€æ–°å€¼
  }, [count]);

  const handleClick = () => {
    setCount(count + 1);
  };

  return <button onClick={handleClick}>ç‚¹å‡»ï¼š{count}</button>;
}
```

### ğŸ” åŸå› åˆ†æ
1. `setState` æ˜¯**å¼‚æ­¥**çš„ï¼Œä¸ä¼šç«‹å³æ›´æ–°
2. React ä¼šæ‰¹é‡å¤„ç†çŠ¶æ€æ›´æ–°ï¼Œæé«˜æ€§èƒ½
3. åœ¨ `setState` ä¹‹åç«‹å³è®¿é—® stateï¼Œæ‹¿åˆ°çš„è¿˜æ˜¯é—­åŒ…ä¸­çš„æ—§å€¼

### ğŸ’¡ æ€»ç»“ä¸å»¶ä¼¸
- React 18+ ä¸­ï¼Œæ‰€æœ‰æ›´æ–°éƒ½æ˜¯æ‰¹é‡çš„ï¼ˆåŒ…æ‹¬å¼‚æ­¥å‡½æ•°ä¸­çš„æ›´æ–°ï¼‰
- å¦‚æœéœ€è¦åŸºäºæ—§çŠ¶æ€è®¡ç®—æ–°çŠ¶æ€ï¼Œä½¿ç”¨å‡½æ•°å¼æ›´æ–°ï¼š`setState(prev => prev + 1)`
- å¦‚æœéœ€è¦åœ¨çŠ¶æ€æ›´æ–°åæ‰§è¡Œæ“ä½œï¼Œä½¿ç”¨ `useEffect`
- æ³¨æ„é—­åŒ…é™·é˜±ï¼Œå°¤å…¶æ˜¯åœ¨å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨ä¸­

### ğŸ”– æ ‡ç­¾
`#react` `#useState` `#async` `#closure`

---

## ğŸ é—®é¢˜ 3ï¼škey è­¦å‘Šå’Œåˆ—è¡¨æ¸²æŸ“é—®é¢˜

### ğŸ’¬ å‘ç°åœºæ™¯
æ¸²æŸ“åˆ—è¡¨æ—¶ï¼Œæ§åˆ¶å°å‡ºç°è­¦å‘Šï¼š"Warning: Each child in a list should have a unique 'key' prop."

### âŒ é”™è¯¯ç¤ºä¾‹
```jsx
function TodoList({ todos }) {
  return (
    <ul>
      {/* ğŸš¨ é”™è¯¯ 1ï¼šæ²¡æœ‰ key */}
      {todos.map(todo => (
        <li>{todo.text}</li>
      ))}
      
      {/* ğŸš¨ é”™è¯¯ 2ï¼šä½¿ç”¨ index ä½œä¸º keyï¼ˆå½“åˆ—è¡¨ä¼šå˜åŒ–æ—¶ï¼‰*/}
      {todos.map((todo, index) => (
        <li key={index}>{todo.text}</li>
      ))}
    </ul>
  );
}
```

### âœ… æ­£ç¡®å†™æ³•
```jsx
function TodoList({ todos }) {
  return (
    <ul>
      {/* âœ… ä½¿ç”¨å”¯ä¸€ä¸”ç¨³å®šçš„ ID ä½œä¸º key */}
      {todos.map(todo => (
        <li key={todo.id}>{todo.text}</li>
      ))}
    </ul>
  );
}
```

### ğŸ” åŸå› åˆ†æ
1. React ä½¿ç”¨ `key` æ¥è¿½è¸ªåˆ—è¡¨ä¸­çš„å…ƒç´ 
2. æ²¡æœ‰ key æˆ–ä½¿ç”¨ index ä½œä¸º key ä¼šå¯¼è‡´ï¼š
   - æ€§èƒ½é—®é¢˜ï¼ˆæ— æ³•æ­£ç¡®å¤ç”¨å…ƒç´ ï¼‰
   - çŠ¶æ€é”™ä¹±ï¼ˆåˆ é™¤/æ’å…¥å…ƒç´ æ—¶ï¼‰
   - åŠ¨ç”»/è¿‡æ¸¡æ•ˆæœå¼‚å¸¸

**ç¤ºä¾‹ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç”¨ index**
```jsx
// åˆå§‹åˆ—è¡¨ï¼š[A, B, C]
// index:    [0, 1, 2]

// åˆ é™¤ B åï¼š[A, C]
// index:     [0, 1]

// React è®¤ä¸ºï¼š
// - å…ƒç´  0 (A) æ²¡å˜
// - å…ƒç´  1 ä» B å˜æˆäº† Cï¼ˆä¼šé‡æ–°æ¸²æŸ“æˆ–çŠ¶æ€é”™ä¹±ï¼‰
// - å…ƒç´  2 (C) è¢«åˆ é™¤äº†
```

### ğŸ’¡ æ€»ç»“ä¸å»¶ä¼¸
- æ°¸è¿œä½¿ç”¨**å”¯ä¸€ä¸”ç¨³å®š**çš„ ID ä½œä¸º key
- å¦‚æœæ•°æ®æ²¡æœ‰ IDï¼Œå¯ä»¥åœ¨è·å–æ•°æ®æ—¶ç”Ÿæˆï¼ˆå¦‚ç”¨ `uuid` åº“ï¼‰
- åªæœ‰åœ¨åˆ—è¡¨æ˜¯**é™æ€**ä¸”**ä¸ä¼šé‡æ–°æ’åº**æ—¶æ‰èƒ½ç”¨ index
- key åº”è¯¥åœ¨**å…„å¼Ÿå…ƒç´ **ä¹‹é—´å”¯ä¸€ï¼Œä¸éœ€è¦å…¨å±€å”¯ä¸€

### ğŸ”– æ ‡ç­¾
`#react` `#key` `#list-rendering` `#warning`

---

## ğŸ é—®é¢˜ 4ï¼šProps è§£æ„å¯¼è‡´çš„é»˜è®¤å€¼é™·é˜±

### ğŸ’¬ å‘ç°åœºæ™¯
ç»™ç»„ä»¶ä¼ é€’äº† `undefined` ä½œä¸º propï¼Œä½†é»˜è®¤å€¼æ²¡æœ‰ç”Ÿæ•ˆã€‚

### âŒ é”™è¯¯ç¤ºä¾‹
```jsx
// çˆ¶ç»„ä»¶
<Button size={undefined} /> // ğŸš¨ ä¼ é€’äº† undefined

// å­ç»„ä»¶
function Button({ size = 'medium' }) {
  console.log(size); // è¾“å‡º: undefinedï¼ˆè€Œä¸æ˜¯ 'medium'ï¼‰
  return <button className={`btn-${size}`}>æŒ‰é’®</button>;
}
```

### âœ… æ­£ç¡®å†™æ³•

**æ–¹æ³• 1ï¼šåœ¨çˆ¶ç»„ä»¶ä¸ä¼ é€’ undefined**
```jsx
// çˆ¶ç»„ä»¶
<Button /> // âœ… ä¸ä¼ é€’è¿™ä¸ª prop
// æˆ–
<Button size={someValue || undefined} /> // ä½¿ç”¨æ¡ä»¶æ¸²æŸ“
```

**æ–¹æ³• 2ï¼šåœ¨å­ç»„ä»¶ä¸­å¤„ç†**
```jsx
function Button({ size }) {
  const actualSize = size ?? 'medium'; // âœ… ä½¿ç”¨ç©ºå€¼åˆå¹¶è¿ç®—ç¬¦
  return <button className={`btn-${actualSize}`}>æŒ‰é’®</button>;
}
```

**æ–¹æ³• 3ï¼šä½¿ç”¨å¯¹è±¡è§£æ„çš„é»˜è®¤å€¼**
```jsx
function Button(props) {
  const { size = 'medium' } = props.size === undefined ? {} : props;
  // æˆ–è€…æ›´ç®€æ´ï¼š
  const size = props.size ?? 'medium';
  return <button className={`btn-${size}`}>æŒ‰é’®</button>;
}
```

### ğŸ” åŸå› åˆ†æ
1. JavaScript çš„å‚æ•°é»˜è®¤å€¼åªåœ¨å‚æ•°ä¸º `undefined` æ—¶ç”Ÿæ•ˆ
2. å¦‚æœæ˜¾å¼ä¼ é€’äº† `undefined`ï¼Œå®ƒä¼šè¦†ç›–é»˜è®¤å€¼
3. è¿™æ˜¯ JavaScript çš„ç‰¹æ€§ï¼Œä¸æ˜¯ React çš„é—®é¢˜

### ğŸ’¡ æ€»ç»“ä¸å»¶ä¼¸
- é¿å…æ˜¾å¼ä¼ é€’ `undefined` ä½œä¸º prop
- ä½¿ç”¨ `??`ï¼ˆç©ºå€¼åˆå¹¶ï¼‰æˆ– `||`ï¼ˆé€»è¾‘æˆ–ï¼‰å¤„ç†é»˜è®¤å€¼
- TypeScript å¯ä»¥å¸®åŠ©æ£€æµ‹è¿™ç±»é—®é¢˜
- å¯ä»¥ä½¿ç”¨ PropTypes çš„ `defaultProps` æ¥å®šä¹‰é»˜è®¤å€¼

### ğŸ”– æ ‡ç­¾
`#react` `#props` `#javascript` `#default-values`

---

## ğŸ“Œ å¸¸è§é”™è¯¯é€ŸæŸ¥

| é”™è¯¯ç±»å‹ | ç—‡çŠ¶ | å¿«é€Ÿè§£å†³ |
|---------|------|---------|
| useEffect æ— é™å¾ªç¯ | é¡µé¢å¡æ­»ï¼Œæ§åˆ¶å°ç–¯ç‹‚æ‰“å° | æ£€æŸ¥ä¾èµ–æ•°ç»„ï¼Œä¸è¦ä¾èµ–ä¼šå˜åŒ–çš„å¯¹è±¡ |
| çŠ¶æ€æ›´æ–°ä¸åŠæ—¶ | setState åç«‹å³è¯»å–æ˜¯æ—§å€¼ | ä½¿ç”¨å‡½æ•°å¼æ›´æ–°æˆ– useEffect |
| key è­¦å‘Š | æ§åˆ¶å°è­¦å‘Š | ä½¿ç”¨å”¯ä¸€ ID è€Œé index |
| å†…å­˜æ³„æ¼ | ç»„ä»¶å¸è½½åä»åœ¨æ›´æ–°çŠ¶æ€ | useEffect ä¸­è¿”å›æ¸…ç†å‡½æ•° |
| é—­åŒ…é™·é˜± | å®šæ—¶å™¨ä¸­æ‹¿åˆ°çš„æ˜¯æ—§çŠ¶æ€ | ä½¿ç”¨ useRef æˆ–å‡½æ•°å¼æ›´æ–° |

---

## ğŸ”— æ·±åº¦åˆ†ææ–‡ç« 

å¯¹äºç‰¹åˆ«å¤æ‚çš„é—®é¢˜ï¼Œæˆ‘ä¼šåˆ›å»ºç‹¬ç«‹çš„æ·±åº¦åˆ†ææ–‡æ¡£ï¼š

- [â­ å¼¹çª—æ»šåŠ¨äº‹ä»¶é—®é¢˜ï¼špassive ç›‘å¬å™¨ + å¾®å‰ç«¯ iframe è¾¹ç•Œ](./passive-events-and-iframe-boundary.md)
  - æ¶‰åŠï¼šäº‹ä»¶ç›‘å¬ã€passiveã€composedPathã€å¾®å‰å‰ç«¯
  - éš¾åº¦ï¼šâ­â­â­â­â­
  - ç»éªŒä»·å€¼ï¼šéå¸¸é«˜

---

**æœ€åæ›´æ–°ï¼š** 2025-10-16

