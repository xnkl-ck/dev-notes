# **js 宏任务与微任务都是指什么，优先级如何？**

## 前言

JavaScript 运行时中，异步任务的调度主要依赖于宏任务和微任务两类队列。理解它们的定义、区别以及优先级顺序，对于正确掌控异步执行流程、避免竞态条件和性能优化非常重要。本文将详细介绍宏任务与微任务的概念、分类和执行顺序。

## 宏任务（Macrotask）

宏任务是指浏览器或环境中的较大单元异步任务，通常包括：

- 定时器任务，如 `setTimeout`、`setInterval`
- 用户交互事件，如点击、键盘输入
- 网络请求回调，如 XMLHttpRequest、Fetch 回调
- UI 渲染任务
- Node.js 中的 I/O 操作和 `setImmediate`

宏任务是事件循环中执行的基本单元，每次循环都会从宏任务队列取一个任务执行。

## 微任务（Microtask）

微任务是指更细粒度的异步任务，它们会在当前宏任务执行完毕后立即执行，确保在浏览器渲染或事件循环进入下一轮之前完成。常见的微任务包括：

- Promise 的回调函数（`then`、`catch`、`finally`）
- `MutationObserver` 的回调
- Node.js 中的 `process.nextTick`

微任务队列会在每个宏任务执行结束后被清空，执行所有微任务后才会继续执行下一个宏任务。

## 优先级与执行顺序

事件循环机制中，每轮循环遵循以下顺序：

1. 执行一个宏任务
2. 执行当前宏任务产生的所有微任务（直到微任务队列为空）
3. 浏览器进行渲染（如果有必要）
4. 进入下一轮宏任务循环

这意味着微任务的优先级高于宏任务，微任务会紧跟着宏任务执行后立即执行。

## 代码示例说明

```plain
console.log('script start');

setTimeout(() => {
  console.log('setTimeout'); // 宏任务
}, 0);

Promise.resolve().then(() => {
  console.log('promise1'); // 微任务
}).then(() => {
  console.log('promise2'); // 微任务
});

console.log('script end');
```

输出顺序：

```plain
script start
script end
promise1
promise2
setTimeout
```

解释：

- 同步代码先执行。
- Promise 的回调进入微任务队列，优先于 `setTimeout` 执行。
- `setTimeout` 是宏任务，等待微任务完成后执行。

## 微任务的作用

微任务保证在当前执行上下文结束后立即执行一些重要任务，如 Promise 状态变更的回调，确保数据及时更新，避免 UI 频繁重绘。

合理利用微任务，有助于编写高效响应的异步代码。

## 面试回答

宏任务是事件循环中执行的基本单元，包含 `setTimeout`、用户事件、网络请求回调等较大异步任务。

微任务是更细粒度的异步任务，如 Promise 的回调和 `MutationObserver`。

在事件循环中，每轮先执行一个宏任务，然后执行所有微任务，最后才进行渲染和下一轮宏任务。因此，微任务优先级高于宏任务，能够保证异步代码更及时地执行。

## 总结

宏任务和微任务是 JavaScript 异步机制的两大核心。宏任务执行频率低，范围大；微任务执行频繁，优先级高。掌握它们的区别及执行顺序，有助于写出更高效、稳定的异步代码。