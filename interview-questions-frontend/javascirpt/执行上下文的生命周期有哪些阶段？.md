# **执行上下文的生命周期有哪些阶段？**

## 前言

理解执行上下文的生命周期，是深入掌握 JavaScript 代码执行过程的关键。执行上下文不仅是代码的执行环境，还经历多个阶段的变化，影响变量初始化、函数声明、作用域链构建等环节。本文将详细拆解执行上下文生命周期的各个阶段，帮助你更好理解 JS 引擎如何执行代码，也为面试提供专业答题参考。

## 执行上下文的生命周期阶段

执行上下文的生命周期大致可以分为两个主要阶段：创建阶段和执行阶段。

### 1. 创建阶段（也称为“变量对象初始化阶段”）

在这个阶段，JavaScript 引擎会做以下几件事：

- 创建变量对象（Variable Object，VO），存储函数内声明的变量和函数声明
- 解析函数声明，函数名绑定到变量对象
- 变量声明提升，变量会被声明但未赋值，初始化为 `undefined`
- 建立作用域链，执行上下文会通过作用域链指向当前变量对象和外部上下文的变量对象
- 确定 `this` 指向

此阶段，变量提升和函数提升就发生在这里，使得函数声明和变量声明可以在代码前面调用。

### 2. 执行阶段

创建完成后，执行上下文进入执行阶段，代码逐行执行：

- 变量赋值开始生效，函数表达式的赋值也在此阶段完成
- 代码中的函数体开始执行
- 变量和函数逐步被初始化具体值，供后续代码使用

### 3. 执行上下文的销毁

当函数执行完毕或者全局代码执行结束后，对应的执行上下文会从执行上下文栈中弹出，生命周期结束。

需要注意的是，闭包会使得某些函数执行上下文中的变量对象不会被立即销毁，因为它们仍被引用。

## 变量提升与执行上下文的关系

变量提升本质上是创建阶段的一部分。变量和函数声明会被提前注册到变量对象中，但变量只声明未赋值，函数声明则会被完整注册。

```plain
function test() {
  console.log(a); // undefined
  console.log(foo()); // 3

  var a = 1;
  function foo() {
    return 3;
  }
}
test();
```

这里 `a` 是变量声明被提升，初始值是 `undefined`；而函数 `foo` 完整提升，可以直接调用。

## 面试回答

**问题：执行上下文的生命周期有哪些阶段？**

回答示范：

执行上下文的生命周期主要分为两个阶段，创建阶段和执行阶段。创建阶段时，JavaScript 会创建变量对象，把函数声明和变量声明提升到变量对象里，建立作用域链，并确定 this 指向。执行阶段则是代码逐行执行，变量赋值生效，函数体被执行。执行完成后，执行上下文会从调用栈中弹出。理解这两个阶段，有助于掌握变量提升、作用域链形成和代码执行顺序。

## 总结

执行上下文的生命周期直接影响 JavaScript 变量提升、作用域链构建和代码执行流程。掌握创建和执行两个阶段，有助于你深入理解 JS 运行机制和排查复杂作用域或变量问题。在面试中清晰表达这些概念，能够彰显你的专业水平。